

library(ggplot2)

prepare_dataset_for_project1 <- function(filename, columns_to_remove){
  df <- read_csv(filename)
  # usuwamy kolumny, które nie są nam potrzebne lub zawierały zbyt dużo braków
  df <- df[ , !(names(df) %in% columns_to_remove)]
  # usuwamy wiersze, które miały brakujące wartości
  df <- drop_na(df)
  return(df)
}

df <- prepare_dataset_for_project1('j:/Downloads/apartments_pl_2023_08.csv',
                                   c('floor', 'latitude', 'longitude',
                                     'ownership','buildingMaterial', 'condition'))

df$city <- recode(df$city,
                  "bialystok" = "Białystok", "bydgoszcz" = "Bydgoszcz", "czestochowa" = "Częstochowa",
                  "gdansk" = "Gdańsk", "gdynia" = "Gdynia", "katowice" = "Katowice",
                  "krakow" = "Kraków", "lodz" = "Łódź", "lublin" = "Lublin",
                  "poznan" = "Poznań", "radom" = "Radom", "rzeszow" = "Rzeszów",
                  "szczecin" = "Szczecin", "warszawa" = "Warszawa", "wroclaw" = "Wrocław")


# Podział centreDistance na kategorie
df$centreDistanceCategory <- cut(df$centreDistance, breaks = c(0, 4,8, 16, Inf), include.lowest = TRUE, labels = c("(0,4]", "(4,8]", "(8,16]", "ponad 16"))

# Kumulacja wartości poiCount w obrębie każdej kategorii odległości
df <- df %>% 
  group_by(city, centreDistanceCategory) %>% 
  arrange(centreDistance) %>%
  mutate(cumulative_poiCount = cumsum(poiCount))

# Wykres słupkowy
wykres_slupkowy <- ggplot(df, aes(x = reorder(city, -cumulative_poiCount), y = poiCount, fill = centreDistanceCategory)) +
  geom_bar(stat = "identity", position = "identity") +
  labs(
    x = "Miasto",
    y = "Liczba Point of Interest (POI)",
    title = "Liczba POI w poszczególnych miastach z podziałem na odległość od centrum"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),  # Rotacja etykiet osi X
    panel.grid.major = element_line(color = "gray", size = 0.5),
    panel.grid.minor = element_line(color = "gray", size = 0.5),
    axis.ticks = element_blank(),
    axis.line = element_line(color = "black", size = 1),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(hjust = 0.5, vjust = 0.5, size = 14, face = "bold", margin = margin(10, 0, 10, 0))
  ) +
  guides(
    fill = guide_legend(title = "Odległość od centrum (w km)")
  )

# Wyświetl wykres
wykres_slupkowy
